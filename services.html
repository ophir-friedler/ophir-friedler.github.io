<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>בחירת שירותים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/style.css?v=2">
</head>
<body>
  <div class="container">
    <div id="user-submissions-section" style="display:none;">
      <h3>ההזמנות הקודמות שלך</h3>
      <div id="user-submissions-list"></div>
    </div>
    <h1>בחר שירותים</h1>
    <form id="services-form">
      <label><input type="checkbox" name="service" value="תספורת"> תספורת</label><br>
      <label><input type="checkbox" name="service" value="צבע"> צבע</label><br>
      <label><input type="checkbox" name="service" value="פן"> פן</label><br>
      <label><input type="checkbox" name="service" value="החלקה"> החלקה</label><br>
      <label><input type="checkbox" name="service" value="תספורת ילדים"> תספורת ילדים</label><br>
      <button type="submit">בחירת תאריך</button>
    </form>
    <p id="status"></p>
  </div>
  <script>
    const API_URL = "https://flask-supabase-backend.onrender.com";
    // Get business name from URL or localStorage
    let businessName = new URLSearchParams(window.location.search).get("business_name") || localStorage.getItem("business_name");
    if (businessName) {
      localStorage.setItem("business_name", businessName);
    }

    document.getElementById("services-form").addEventListener("submit", function(event) {
      event.preventDefault();
      const selected = Array.from(document.querySelectorAll('input[name="service"]:checked')).map(cb => cb.value);
      if (selected.length === 0) {
        document.getElementById("status").textContent = "נא לבחור לפחות שירות אחד.";
        return;
      }
      // Save selected services to localStorage for the next page
      localStorage.setItem("selected_services", JSON.stringify(selected));
      // Redirect to the date selection page, passing business name in URL
      window.location.href = `date.html?business_name=${encodeURIComponent(businessName)}`;
    });

    const userInput = localStorage.getItem("user_input");

    async function loadUserSubmissions() {
      if (!userInput || !businessName) return;
      const res = await fetch(`${API_URL}/user-submissions?user_input=${encodeURIComponent(userInput)}&business_name=${encodeURIComponent(businessName)}`);
      if (!res.ok) {
        document.getElementById("user-submissions-list").textContent = "שגיאה בטעינת ההזמנות.";
        document.getElementById("user-submissions-section").style.display = "block";
        return;
      }
      const submissions = await res.json();
      renderUserSubmissions(submissions);
    }

    function renderUserSubmissions(submissions) {
      const listDiv = document.getElementById("user-submissions-list");
      listDiv.innerHTML = "";
      if (!submissions.length) {
        listDiv.textContent = "לא נמצאו הזמנות קודמות.";
        document.getElementById("user-submissions-section").style.display = "block";
        return;
      }
      submissions.forEach(sub => {
        const div = document.createElement("div");
        div.className = "user-submission-item";
        div.innerHTML = `
          <strong>שירותים:</strong> ${(sub.content?.selected_services || []).join(", ")}<br>
          <strong>תאריך:</strong> ${sub.content?.selected_time || ""}<br>
          <hr>
        `;
        listDiv.appendChild(div);
      });
      document.getElementById("user-submissions-section").style.display = "block";
    }

    // Call this when the page loads
    loadUserSubmissions();
  </script>
</body>
</html>